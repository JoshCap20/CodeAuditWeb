<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CodeAuditWeb</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        textarea {
            width: 100%;
            height: 150px;
        }

        .container {
            margin-bottom: 20px;
        }

        .button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .button:hover {
            background-color: #0056b3;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" type="text/javascript"
        charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.js"></script>

</head>

<body>
    <div class="container">
        <label for="codeInput">Python Code:</label>
        <div id="codeInput" style="height: 150px; width: 100%;"></div>
    </div>

    <div class="container">
        <label>Options:</label><br>
        <input type="checkbox" id="time" name="option" value="time">
        <label for="timer">Time Performance</label><br>
        <input type="checkbox" id="memory" name="option" value="memory">
        <label for="memory">Memory Performance</label><br>
        <input type="checkbox" id="profile" name="option" value="profile">
        <label for="profile">Profile Code</label><br>
        <input type="checkbox" id="flamegraph" name="option" value="flamegraph">
        <label for="flamegraph">Flame Graph</label><br>
        <input type="checkbox" id="dotgraph" name="option" value="dotgraph">
        <label for="dotgraph">Dot Graph</label><br>
    </div>

    <div class="container">
        <label for="iterations">Iterations:</label>
        <input type="number" id="iterations" min="1" value="1">
    </div>

    <button class="button" onclick="submitCode(); return false;">Run Code</button>

    <!-- Placeholder for results -->
    <div id="inputs"></div>
    <div id="outputs"></div>

    <script>
        function submitCode() {
            var code = document.getElementById('codeInput').value;
            var iterations = document.getElementById('iterations').value;
            var options = document.querySelectorAll('input[name="option"]:checked');
            var selectedOptions = Array.from(options).map(function (el) { return el.value; });

            document.getElementById('inputs').innerHTML = 'Code: ' + code +
                '<br>Iterations: ' + iterations +
                '<br>Selected Options: ' + selectedOptions.join(', ');

            getResults(code, selectedOptions, iterations);
        }

        async function getResults(code, options, iterations) {
            document.getElementById('outputs').innerHTML = 'Loading...';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: {
                            code_str: code,
                        },
                        options: options,
                        iterations: iterations
                    })
                });
                const myJson = await response.json();
                let formattedResults = '<h2>Results:</h2>';

                if (myJson.time) {
                    formattedResults += '<div><strong>Execution Time:</strong><br>';
                    formattedResults += `Milliseconds: ${myJson.time.milliseconds}<br>`;
                    formattedResults += `Seconds: ${myJson.time.seconds}<br>`;
                    formattedResults += `Minutes: ${myJson.time.minutes}</div>`;
                }

                if (myJson.memory) {
                    formattedResults += '<div><strong>Memory Usage:</strong><br>';
                    formattedResults += `Kilobytes: ${myJson.memory.kilobytes}<br>`;
                    formattedResults += `Megabytes: ${myJson.memory.megabytes}<br>`;
                    formattedResults += `Gigabytes: ${myJson.memory.gigabytes}</div>`;
                }

                if (myJson.profile) {
                    formattedResults += `<div><strong>Profile Data:</strong><pre style="font-family: monospace;">${escapeHtml(myJson.profile)}</pre></div>`;
                }

                if (myJson.flamegraph) {
                    formattedResults += `<div><strong>Flame Graph:</strong> <a href="/flamegraph" target="_blank">View</a></div>`;
                }

                document.getElementById('outputs').innerHTML = formattedResults;
            } catch (error) {
                console.error('Error fetching results:', error);
                document.getElementById('outputs').innerHTML = 'Failed to get results.';
            }
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        document.addEventListener('DOMContentLoaded', function () {
            var editor = ace.edit("codeInput");
            editor.setTheme("ace/theme/twilight");
            editor.setOption("enableFoldWidgets", true);
            editor.getSession().setMode("ace/mode/python");
            editor.getSession().setUseWrapMode(true);
            editor.setOptions({
                enableBasicAutocompletion: true,
                enableSnippets: true,
                enableLiveAutocompletion: true,
                tabSize: 4,
                useSoftTabs: true
            });

            // Update the submitCode function to get code from the editor
            window.submitCode = function () {
                var code = editor.getValue();
                var iterations = document.getElementById('iterations').value;
                var options = document.querySelectorAll('input[name="option"]:checked');
                var selectedOptions = Array.from(options).map(function (el) { return el.value; });

                document.getElementById('inputs').innerHTML = 'Code: ' + escapeHtml(code) +
                    '<br>Iterations: ' + iterations +
                    '<br>Selected Options: ' + selectedOptions.join(', ');

                getResults(code, selectedOptions, iterations);
            }
        });


    </script>
</body>

</html>